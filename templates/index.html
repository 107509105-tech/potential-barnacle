<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF RAG å•ç­”ç³»çµ±</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>PDF RAG å•ç­”ç³»çµ±</h1>
            <p class="subtitle">åŸºæ–¼ Gemma 3 å’Œ BGE-M3 çš„æ™ºèƒ½æ–‡ä»¶å•ç­”</p>
        </header>

        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-label">æ–‡æª”æ•¸é‡ï¼š</span>
                <span class="stat-value" id="total-docs">{{ stats.total_documents or 0 }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">å‘é‡ç¶­åº¦ï¼š</span>
                <span class="stat-value">{{ stats.vector_dim or 1024 }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">æ¨¡å‹ï¼š</span>
                <span class="stat-value">BGE-M3</span>
            </div>
        </div>

        <div class="main-content">
            <!-- ä¸Šå‚³å€åŸŸ -->
            <section class="upload-section">
                <h2>ä¸Šå‚³ PDF æ–‡ä»¶</h2>
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">ğŸ“„</div>
                    <p>é»æ“Šé¸æ“‡æˆ–æ‹–æ”¾ PDF æª”æ¡ˆ</p>
                    <input type="file" id="file-input" accept=".pdf" hidden>
                    <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                        é¸æ“‡æª”æ¡ˆ
                    </button>
                </div>
                <div id="upload-status" class="status-message"></div>
            </section>

            <!-- å•ç­”å€åŸŸ -->
            <section class="query-section">
                <h2>æå•æŸ¥è©¢</h2>
                <div class="query-form">
                    <textarea
                        id="question-input"
                        placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œï¼ˆæ”¯æ´ç¹é«”ä¸­æ–‡ï¼‰..."
                        rows="4"
                    ></textarea>
                    <button class="btn btn-primary" onclick="submitQuery()">
                        é€å‡ºå•é¡Œ
                    </button>
                </div>
                <div id="query-status" class="status-message"></div>
            </section>

            <!-- çµæœé¡¯ç¤ºå€åŸŸ -->
            <section class="results-section" id="results-section" style="display: none;">
                <h2>æŸ¥è©¢çµæœ</h2>

                <div class="answer-box">
                    <h3>ç­”æ¡ˆ</h3>
                    <div id="answer-content" class="answer-content"></div>
                </div>

                <div class="sources-box">
                    <h3>ä¾†æºé é¢</h3>
                    <div id="sources-content" class="sources-grid"></div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // æª”æ¡ˆä¸Šå‚³è™•ç†
        const fileInput = document.getElementById('file-input');
        const uploadArea = document.getElementById('upload-area');
        const uploadStatus = document.getElementById('upload-status');

        fileInput.addEventListener('change', handleFileSelect);

        // æ‹–æ”¾æ”¯æ´
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        }

        async function handleFileUpload(file) {
            if (!file.name.endsWith('.pdf')) {
                showStatus(uploadStatus, 'è«‹é¸æ“‡ PDF æª”æ¡ˆ', 'error');
                return;
            }

            showStatus(uploadStatus, 'æ­£åœ¨ä¸Šå‚³å’Œç´¢å¼• PDFï¼Œè«‹ç¨å€™...', 'loading');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus(
                        uploadStatus,
                        `æˆåŠŸï¼è™•ç†äº† ${result.pages_processed} é ï¼Œè³‡æ–™åº«å…±æœ‰ ${result.total_docs} å€‹æ–‡æª”`,
                        'success'
                    );
                    // æ›´æ–°çµ±è¨ˆæ•¸å­—
                    document.getElementById('total-docs').textContent = result.total_docs;
                } else {
                    showStatus(uploadStatus, `éŒ¯èª¤ï¼š${result.detail}`, 'error');
                }
            } catch (error) {
                showStatus(uploadStatus, `ä¸Šå‚³å¤±æ•—ï¼š${error.message}`, 'error');
            }
        }

        // å•é¡ŒæŸ¥è©¢è™•ç†
        async function submitQuery() {
            const question = document.getElementById('question-input').value.trim();
            const queryStatus = document.getElementById('query-status');

            if (!question) {
                showStatus(queryStatus, 'è«‹è¼¸å…¥å•é¡Œ', 'error');
                return;
            }

            showStatus(queryStatus, 'æ­£åœ¨æœå°‹å’Œç”Ÿæˆç­”æ¡ˆï¼Œè«‹ç¨å€™...', 'loading');

            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        top_k: 3
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus(queryStatus, 'æŸ¥è©¢å®Œæˆï¼', 'success');
                    displayResults(result);
                } else {
                    showStatus(queryStatus, `éŒ¯èª¤ï¼š${result.detail}`, 'error');
                }
            } catch (error) {
                showStatus(queryStatus, `æŸ¥è©¢å¤±æ•—ï¼š${error.message}`, 'error');
            }
        }

        // é¡¯ç¤ºçµæœ
        function displayResults(result) {
            const resultsSection = document.getElementById('results-section');
            const answerContent = document.getElementById('answer-content');
            const sourcesContent = document.getElementById('sources-content');

            // é¡¯ç¤ºç­”æ¡ˆ
            answerContent.innerHTML = `<p>${result.answer.replace(/\n/g, '<br>')}</p>`;

            // é¡¯ç¤ºä¾†æº
            sourcesContent.innerHTML = '';
            result.sources.forEach((source, index) => {
                const sourceCard = document.createElement('div');
                sourceCard.className = 'source-card';

                const imagePath = source.image_path.split('/').pop();
                const bboxes = source.bboxes || [];

                sourceCard.innerHTML = `
                    <div class="image-container" style="position: relative;">
                        <img src="/image/${imagePath}"
                             alt="ç¬¬ ${source.page_num} é "
                             class="source-image"
                             id="source-img-${index}"
                             crossorigin="anonymous">
                        <canvas id="bbox-canvas-${index}"
                                class="bbox-canvas"
                                style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                    </div>
                    <div class="source-info">
                        <div class="source-title">${source.doc_name}</div>
                        <div class="source-page">ç¬¬ ${source.page_num} é </div>
                        <div class="source-similarity">ç›¸ä¼¼åº¦: ${(source.similarity * 100).toFixed(1)}%</div>
                    </div>
                `;

                sourcesContent.appendChild(sourceCard);

                // åœ–åƒåŠ è¼‰å®Œæˆå¾Œç¹ªè£½é‚Šç•Œæ¡†
                const img = document.getElementById(`source-img-${index}`);
                img.dataset.bboxes = JSON.stringify(bboxes);
                img.onload = function() {
                    drawBoundingBoxes(index, bboxes, img);
                };
            });

            // é¡¯ç¤ºçµæœå€åŸŸ
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ç¹ªè£½é‚Šç•Œæ¡†å‡½æ•¸
        function drawBoundingBoxes(imageIndex, bboxes, imgElement) {
            if (!bboxes || bboxes.length === 0) {
                return;
            }

            const canvas = document.getElementById(`bbox-canvas-${imageIndex}`);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // è¨­ç½® Canvas å°ºå¯¸èˆ‡åœ–åƒç›¸åŒ
            canvas.width = imgElement.offsetWidth;
            canvas.height = imgElement.offsetHeight;

            // æ¸…ç©º Canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ç¹ªè£½æ¯å€‹é‚Šç•Œæ¡†
            bboxes.forEach(bbox => {
                // å°‡ç™¾åˆ†æ¯”åæ¨™è½‰æ›ç‚ºåƒç´ åæ¨™
                const x1 = (bbox.x1 / 100) * canvas.width;
                const y1 = (bbox.y1 / 100) * canvas.height;
                const x2 = (bbox.x2 / 100) * canvas.width;
                const y2 = (bbox.y2 / 100) * canvas.height;

                const width = x2 - x1;
                const height = y2 - y1;

                // ç¹ªè£½åŠé€æ˜å¡«å……
                ctx.fillStyle = 'rgba(255, 0, 0, 0.1)';
                ctx.fillRect(x1, y1, width, height);

                // ç¹ªè£½é‚Šæ¡†
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 3;
                ctx.strokeRect(x1, y1, width, height);
            });
        }

        // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–ï¼Œé‡æ–°ç¹ªè£½
        window.addEventListener('resize', () => {
            const sourcesContent = document.getElementById('sources-content');
            if (!sourcesContent) return;

            // é‡æ–°ç¹ªè£½æ‰€æœ‰é‚Šç•Œæ¡†
            const sourceCards = sourcesContent.querySelectorAll('.source-card');
            sourceCards.forEach((card, index) => {
                const img = card.querySelector('.source-image');
                const canvas = card.querySelector('.bbox-canvas');

                if (img && canvas && img.dataset.bboxes) {
                    const bboxes = JSON.parse(img.dataset.bboxes);
                    drawBoundingBoxes(index, bboxes, img);
                }
            });
        });

        // ç‹€æ…‹è¨Šæ¯é¡¯ç¤º
        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = `status-message ${type}`;
            element.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // Enter éµé€å‡º
        document.getElementById('question-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitQuery();
            }
        });
    </script>
</body>
</html>
